image: golang:1.18

variables:
  REPO_NAME: gitlab.com/p6339/nopixel/dispatch-tools

stages:
  - test
  - build
  - deploy

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - GOARCH=amd64 GOOS=linux go build -race -ldflags "-s -extldflags '-static'" -o $CI_PROJECT_DIR/dispatch-tools ./cmd/server/main.go
  artifacts:
    paths:
      - dispatch-tools

deploy_prod:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: manual
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - scp $CI_PROJECT_DIR/dispatch-tools dispatch-tools@dispatch.philderbeast.com:/tmp/dispatch-tools
    - |
      ssh dispatch-tools@dispatch.philderbeast.com "sudo /bin/systemctl stop dispatch-tools \
      && mv /tmp/dispatch-tools /opt/dispatch-tools/dispatch-tools \
      && sudo /bin/systemctl start dispatch-tools \
      && sudo /bin/systemctl status dispatch-tools"
  environment:
    name: production
    url: https://dispatch.philderbeast.com

deploy green:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: manual
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - scp $CI_PROJECT_DIR/dispatch-tools dispatch-tools@dispatch.philderbeast.com:/tmp/dispatch-tools
    - |
      ssh dispatch-tools@dispatch.philderbeast.com "sudo /bin/systemctl stop dispatch-tools-green \
      && mv /tmp/dispatch-tools /opt/dispatch-tools-green/dispatch-tools \
      && sudo /bin/systemctl start dispatch-tools-green \
      && sudo /bin/systemctl status dispatch-tools-green"
  environment:
    name: green
    url: https://dispatch-green.philderbeast.com

deploy purple:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: manual
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  script:
    - scp $CI_PROJECT_DIR/dispatch-tools dispatch-tools@dispatch.philderbeast.com:/tmp/dispatch-tools
    - |
      ssh dispatch-tools@dispatch.philderbeast.com "sudo /bin/systemctl stop dispatch-tools-purple \
      && mv /tmp/dispatch-tools /opt/dispatch-tools-purple/dispatch-tools \
      && sudo /bin/systemctl start dispatch-tools-purple \
      && sudo /bin/systemctl status dispatch-tools-purple"
  environment:
    name: purple
    url: https://dispatch-purple.philderbeast.com
